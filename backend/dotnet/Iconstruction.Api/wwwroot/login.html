<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login - IConstruction</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />
</head>
<body class="bg-light">
  <div class="container py-5" style="max-width: 420px;">
    <h1 class="h4 mb-3">Login</h1>
    <div id="alert" class="alert d-none" role="alert"></div>
    <form id="loginForm">
      <div class="form-group">
        <label for="correo">Correo</label>
        <input type="email" class="form-control" id="correo" required />
      </div>
      <div class="form-group">
        <label for="password">Contraseña</label>
        <input type="password" class="form-control" id="password" required />
      </div>
      <button class="btn btn-primary btn-block" type="submit">Ingresar</button>
    </form>
    <div class="mt-3">
      <a href="/index.html">Volver</a>
    </div>
  </div>

  <script>
    (function(){
      var BASE_URL = window.location.origin;
      function setToken(t){ try{ sessionStorage.setItem('token', t); localStorage.setItem('token', t);}catch(e){} }
      function showAlert(msg, type){
        var a = document.getElementById('alert');
        a.className = 'alert alert-' + (type||'danger');
        a.textContent = msg; a.classList.remove('d-none');
      }
      document.getElementById('loginForm').addEventListener('submit', function(ev){
        ev.preventDefault();
        var correo = document.getElementById('correo').value;
        var password = document.getElementById('password').value;
        var xhr = new XMLHttpRequest();
        xhr.open('POST', BASE_URL + '/auth/login');
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function(){
          if(xhr.readyState === 4){
            if(xhr.status >= 200 && xhr.status < 300){
              try{
                var res = JSON.parse(xhr.responseText);
                if(res && res.token){ setToken(res.token); window.location.href = '/stock.html'; return; }
                showAlert('Respuesta inesperada del servidor');
              }catch(e){ showAlert('Error parseando respuesta'); }
            }else if(xhr.status === 401){ showAlert('Credenciales inválidas','warning'); }
            else{ showAlert('Error ' + xhr.status + ': ' + xhr.responseText); }
          }
        };
        xhr.send(JSON.stringify({ correo: correo, password: password }));
      });
    })();
  </script>
</body>
</html>