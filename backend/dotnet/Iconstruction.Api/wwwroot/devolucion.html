<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registrar Devolución - IConstruction</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h4 mb-0">Registrar Devolución</h1>
      <div>
        <a class="btn btn-sm btn-outline-secondary" href="/index.html">Inicio</a>
        <a class="btn btn-sm btn-outline-secondary" href="/prestamos.html">Préstamos</a>
        <button id="logoutBtn" class="btn btn-sm btn-outline-danger">Salir</button>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <div class="form-row">
          <div class="form-group col-md-4">
            <label for="prestamoId">ID de Préstamo</label>
            <input id="prestamoId" class="form-control" type="text" placeholder="Ej: 1001" />
          </div>
          <div class="form-group col-md-2 d-flex align-items-end">
            <button id="loadBtn" class="btn btn-primary btn-block">Cargar</button>
          </div>
          <div class="form-group col-md-3"></div>
          <div class="form-group col-md-3 d-flex align-items-end justify-content-end">
            <button id="fillAllBtn" class="btn btn-outline-secondary">Devolver Todo</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <h2 class="h6">Detalle del Préstamo</h2>
        <div id="meta" class="mb-2 text-muted small"></div>
        <table class="table table-sm table-striped" id="tblDetalle">
          <thead><tr><th>Tipo</th><th>Ítem</th><th>Prestado</th><th>Pendiente</th><th>Devolver</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="text-right">
          <button id="submitBtn" class="btn btn-success">Registrar Devolución</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      if(!window.location.origin){ window.location.origin = window.location.protocol + '//' + window.location.host; }
      var BASE_URL = window.location.origin;
      var current = { id: null, rows: [] };

      function getToken(){ return sessionStorage.getItem('token') || localStorage.getItem('token'); }
      function authHeader(xhr){ var t = getToken(); if(t) xhr.setRequestHeader('Authorization','Bearer ' + t); }
      function ensureAuth(){ if(!getToken()){ window.location.href='/login.html'; } }
      function logout(){ try{ sessionStorage.removeItem('token'); localStorage.removeItem('token'); }catch(e){} window.location.href='/login.html'; }

      function numberOrZero(v){ var n = parseInt(v,10); return isNaN(n)?0:n; }

      function loadDetalle(){
        var id = numberOrZero(document.getElementById('prestamoId').value);
        if(!id){ alert('ID inválido'); return; }
        var xhr = new XMLHttpRequest();
        xhr.open('GET', BASE_URL + '/prestamos/detalle?prestamo_id=' + encodeURIComponent(id));
        authHeader(xhr);
        xhr.onreadystatechange = function(){
          if(xhr.readyState===4){
            if(xhr.status===200){
              try{
                var data = JSON.parse(xhr.responseText)||[];
                current.id = id;
                current.rows = data;
                renderDetalle();
              }catch(e){ alert('Respuesta inválida'); }
            } else {
              alert('No se pudo cargar: ' + xhr.status);
            }
          }
        };
        xhr.send();
      }

      function renderDetalle(){
        var tb = document.querySelector('#tblDetalle tbody');
        tb.innerHTML='';
        var meta = document.getElementById('meta');
        meta.innerHTML = 'Préstamo #' + current.id + ' — filas: ' + (current.rows?current.rows.length:0);
        for(var i=0;i<current.rows.length;i++){
          var r = current.rows[i];
          var pendiente = (r.cantidad_pendiente!=null)?r.cantidad_pendiente:((r.cantidad||0) - (r.cantidad_devuelta||0));
          if(pendiente<0) pendiente = 0;
          var tr = document.createElement('tr');
          tr.innerHTML = '<td>'+ (r.tipo || inferTipo(r)) +'</td>'+
                         '<td>'+ (r.herramienta || r.material || r.item || '') +'</td>'+
                         '<td>'+ (r.cantidad || r.cantidad_prestada || 0) +'</td>'+
                         '<td>'+ pendiente +'</td>'+
                         '<td><input type="text" class="form-control form-control-sm devolver" data-i="'+i+'" value="0" /></td>';
          tb.appendChild(tr);
        }
      }

      function inferTipo(r){ return r.herramienta? 'herramienta' : 'material'; }

      function fillAll(){
        var inputs = document.getElementsByClassName('devolver');
        for(var i=0;i<inputs.length;i++){
          var idx = parseInt(inputs[i].getAttribute('data-i'),10);
          var r = current.rows[idx];
          var pendiente = (r.cantidad_pendiente!=null)?r.cantidad_pendiente:((r.cantidad||0) - (r.cantidad_devuelta||0));
          if(pendiente<0) pendiente = 0;
          inputs[i].value = String(pendiente);
        }
      }

      function submitDevolucion(){
        if(!current.id){ alert('Carga un préstamo primero'); return; }
        var inputs = document.getElementsByClassName('devolver');
        var items = [];
        for(var i=0;i<inputs.length;i++){
          var idx = parseInt(inputs[i].getAttribute('data-i'),10);
          var r = current.rows[idx];
          var devol = numberOrZero(inputs[i].value);
          if(devol>0){
            items.push({
              tipo: inferTipo(r),
              id: r.herramienta_id || r.material_id || r.id,
              cantidad: devol
            });
          }
        }
        if(items.length===0){ alert('No hay cantidades a devolver'); return; }
        var xhr = new XMLHttpRequest();
        xhr.open('POST', BASE_URL + '/prestamos/' + encodeURIComponent(current.id) + '/devoluciones');
        xhr.setRequestHeader('Content-Type','application/json');
        authHeader(xhr);
        xhr.onreadystatechange = function(){
          if(xhr.readyState===4){
            if(xhr.status===200 || xhr.status===201){
              alert('Devolución registrada');
              loadDetalle();
            } else {
              alert('Error al devolver: ' + xhr.status + ' ' + (xhr.responseText||''));
            }
          }
        };
        try{ xhr.send(JSON.stringify({ items: items })); }catch(e){ alert('Error de envío'); }
      }

      document.getElementById('logoutBtn').addEventListener('click', logout);
      document.getElementById('loadBtn').addEventListener('click', function(e){ e.preventDefault?e.preventDefault():null; loadDetalle(); });
      document.getElementById('fillAllBtn').addEventListener('click', function(e){ e.preventDefault?e.preventDefault():null; fillAll(); });
      document.getElementById('submitBtn').addEventListener('click', function(e){ e.preventDefault?e.preventDefault():null; submitDevolucion(); });

      ensureAuth();
    })();
  </script>
</body>
</html>